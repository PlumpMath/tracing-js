<!doctype html>
<html>
	<head>
		<title>.trace</title>
		<meta charset="utf-8" />
		<style type="text/css">
			.line { margin-left: 1ex; width: 80ex; }
			.current-line { background-color: #ddd; }
			.current-expr { background-color: #aaa; }
		</style>
	</head>

	<body>
		<textarea id="code" rows="20" cols="80"></textarea>
		<div id="trace"></div>

		<script src="util.js"></script>
		<script src="trace.js"></script>

		<script src="search_naive.js"></script>
		<script src="search_naive.trace2.js"></script>

		<script src="lib/react.js"></script>
		<script src="trace-ui.js"></script>
		<script>
			var defaultCode = "var pattern = \"Wor\";\nvar string  = \"Hello, World!\";\n\nfor (var i = 0; i < string.length; i++) {\n\tvar j = 0;\n\twhile (j < pattern.length && pattern[j] == string[i + j]) {\n\t\tj++;\n\t}\n\n\tif (j == pattern.length) {\n\t\tconsole.log(\"found match at \" + j);\n\t}\n}\n";

			var codeEl = document.getElementById("code");
			codeEl.value = codeEl.value || defaultCode;

			codeEl.onkeydown = function(ev) {
				if (ev.ctrlKey && ev.keyCode == 13) { // Ctrl+Enter
					var code = encodeURIComponent(codeEl.value);
					var xhr = new XMLHttpRequest();
					xhr.open("GET", "http://localhost:3001/?code=" + code);
					xhr.onreadystatechange = function() {
						if (xhr.readyState == XMLHttpRequest.DONE && xhr.status == 200) {
							var tracingCode = xhr.responseText;
							runTrace(tracingCode);
						}
					}
					xhr.send();
				}
			}

			var code = codeEl.value;
			var rollup = [];
			var pos = 0;

			function runTrace(newCode) {
				Trace.start();
				eval(newCode);
				code = codeEl.value;
				rollup = currentTrace.rollup();
				pos = 0;
				if (traceComponent == null) {
					traceComponent = React.renderComponent(TraceUI2({code: code, trace: rollup[0]}), traceEl);
				}
				renderPos();
			}

			var traceEl = document.getElementById("trace");
			var traceComponent = null;

			function renderPos() {
				traceComponent.setProps({code: code, trace: rollup[pos]});
			}

			document.onkeydown = function(ev) {
				if (document.activeElement == codeEl) {
					return;
				}

				switch (ev.keyCode) {
					case 37:
						pos = Math.max(0, pos - 1);
						renderPos();
						break;
					case 39:
						pos = Math.min(rollup.length - 1, pos + 1);
						renderPos();
						break;
				}
			}
		</script>
	</body>
</html>
